application: myopenreviews
version: 1
runtime: python27
api_version: 1
threadsafe: true

libraries:
- name: pycrypto
  version: "2.3"

builtins:
- remote_api: on

handlers:
######################################################################
##                  API
## authparams:
##   am: authentication method: "mid", "gsid", "fbid", "twid"
##   at: authentication token (from local or supported external source)
##   an: authentication name (username if native auth, whatever otherwise)
##
## Queries may return a base64 cursor value as the last element.
## Optional parameters are listed in parentheses
##
######################################################################

######################################################################
##        Native site authentication 

## Get an access token from native credentials
## POST params: user, pass 
- url: /login.*
  script: src.py.moracct.app

## Read native credentials and redirect back
## POST params: userin, passin (,returnto, command, view, prof/pen/revid)
- url: /redirlogin.*
  script: src.py.moracct.app

## Create a new native account
## POST params: user, pass, email
- url: /newacct.*
  script: src.py.moracct.app

## Email forgotten native account credentials
## POST params: email
- url: /mailcred.*
  script: src.py.moracct.app

## Change native account password
## POST params: password, authparams
- url: /chgpwd.*
  script: src.py.moracct.app

## Get login account details
## GET params: authparams
- url: /getacct.*
  script: src.py.moracct.app


######################################################################
##        Pen Names

## Fetch pen names for current authentication
## GET params: authparams
- url: /mypens.*
  script: src.py.pen.app

## Create new pen name for current authentication
## POST params: pen, authparams
- url: /newpen.*
  script: src.py.pen.app

## Update a pen name if authorized
## POST params: pen, authparams
- url: /updpen.*
  script: src.py.pen.app

## Upload a profile pic
## POST params: picfilein, _id, authparams
##   _id: The PenName instance id
- url: /profpicupload.*
  script: src.py.pen.app

## Retrieve a profile pic
## GET params: profileid
- url: /profpic.*
  script: src.py.pen.app

## Return pen names containing the qstr text.
## GET params: qstr, cursor, authparams
- url: /srchpens.*
  script: src.py.pen.app

## Return the pen name for the given id.
## GET params: penid
- url: /penbyid.*
  script: src.py.pen.app

## Return non-protected account information for the given pen
## GET params: penid, authparams
- url: /acctinfo
  script: src.py.pen.app

## Init an account email address for the given pen
## POST params: penid, email, authparams
- url: /penmail.*
  script: src.py.pen.app



######################################################################
##        Relationships

## Find relationships matching the source or target pen id
## GET params: originid, relatedid, offset, cursor, authparams
- url: /findrels.*
  script: src.py.rel.app

## Create new relationship
## POST params: rel, authparams
- url: /newrel.*
  script: src.py.rel.app

## Delete relationship
## POST params: rel, authparams
- url: /delrel.*
  script: src.py.rel.app

## Update relationship
## POST params: rel, authparams
- url: /updrel.*
  script: src.py.rel.app



######################################################################
##        Reviews

## Create a new review for authorized pen name
## POST params: rev, authparams (, mode)
##   mode=batch leaves a processing note to avoid flooding the activity feed
- url: /newrev.*
  script: src.py.rev.app

## Update review for authorized pen name
## POST params: rev, authparams
##   _id of rev required
- url: /updrev.*
  script: src.py.rev.app

## Delete review for authorized pen name
## POST params: rev, authparams
- url: /delrev.*
  script: src.py.rev.app
  
## Upload a review pic
## POST params: picfilein, _id, authparams
##   _id: The Review instance id
- url: /revpicupload.*
  script: src.py.rev.app

## Retrieve a review pic
## GET params: revid
- url: /revpic.*
  script: src.py.rev.app

## Return reviews for a given pen within the given date range
## GET params: penid, mindate, maxdate, qstr, authparams (,revtype, oldfirst)
- url: /srchrevs.*
  script: src.py.rev.app

## Return the review for the given id.
## GET params: revid
- url: /revbyid.*
  script: src.py.rev.app

## Return the review looking up by revtype and cankey
## GET params: penid, revtype, cankey, authparams
- url: /revbykey
  script: src.py.rev.app

## Return reviews from any pen name ids in the given csv
## GET params: penids, since, cursor
- url: /revact.*
  script: src.py.rev.app



######################################################################
##        Review Tags

## Note the specified review was helpful. helpful: "yes" or "no"
## POST params: penid, revid, helpful, authparams
- url: /notehelpful.*
  script: src.py.revtag.app

## Search the review tags for helpful marks, returning most recent first.
## Specify either penid or revid.  If revid, then penids is a CSV of one
## or more penid values to match.
## GET params: penid, revid, penids, authparams
- url: /srchhelpful.*
  script: src.py.revtag.app

## Note the specified review should be remembered.  remember: "yes" or "no"
## POST params: penid, revid, remember, authparams
- url: /noteremem.*
  script: src.py.revtag.app

## Search the review tags for remember marks, returning most recent first
## penids is a CSV of one or more penid values to match.
## GET params: penid, revid, penids, authparams
- url: /srchremem.*
  script: src.py.revtag.app



######################################################################
##        Review Links

## Search the ReviewLink entries returning any that are in the given
## csv of review ids.
## GET params: revids, authparams
- url: /revlinks.*
  script: src.py.revlink.app


## Update the given ReviewLink
## POST params: revlink, authparams
- url: /updlink.*
  script: src.py.revlink.app



######################################################################
##        Connection Services

## Return a signed OAuth request given the specified parameters
## POST params: name, posturl, headparams, contentparams
- url: /oa1call.*
  script: src.py.consvc.app

## Return the specified JSON endpoint call results
## GET params: geturl
- url: /jsonget.*
  script: src.py.consvc.app

## Fetch an access token for GitHub
## GET params: code, state
- url: /githubtok.*
  script: src.py.consvc.app

## Fetch info from Amazon
## GET params: asin, authparams
- url: /amazoninfo.*
  script: src.py.consvc.app

## Fetch search results from Amazon
## GET params: revtype, title, authparams
- url: /amazonsearch.*
  script: src.py.consvc.app

## Fetch the contents of the given URL
## GET params: url, authparams
- url: /urlcontents.*
  script: src.py.consvc.app



######################################################################
# Static files and other stuff not really part of the API
#
- url: /cluck2.*
  script: src.py.cluck2.app
- url: /cluck.*
  script: src.py.cluck.app
- url: /testpens
  script: src.py.pen.app
- url: /testrevs
  script: src.py.rev.app
- url: /statrev/\d+
  script: src.py.statrev.app
- url: /stats.*
  script: src.py.statweek.app
- url: /rssact.*
  script: src.py.rssact.app
- url: /mailsum.*
  script: src.py.mailsum.app
- url: /logsum.*
  script: src.py.mailsum.app
- url: /emuser.*
  script: src.py.mailsum.app
- url: /activity.*
  script: src.py.mailsum.app
- url: /loginid.*
  script: src.py.moracct.app
# Trap anything ending with a slash and send it to index.html since there
# is no default processing to figure that out otherwise.
- url: (.*)/
  static_files: docroot/index.html
  upload: docroot
# Catchall is to look in docroot.
- url: /
  static_dir: docroot
