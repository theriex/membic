application: myopenreviews
version: 1
runtime: python27
api_version: 1
threadsafe: true

libraries:
- name: pycrypto
  version: "2.3"

builtins:
- remote_api: on

inbound_services:
- mail_bounce

error_handlers:
- error_code: over_quota
  file: overquota.html

handlers:
######################################################################
##                  API
## authparams:
##   am: authentication method: "mid", "gsid", "fbid", "twid"
##   at: authentication token (from local or supported external source)
##   an: authentication name (email if native auth, or 3rd party id info)
##
## Queries may return a base64 cursor value as the last element.
## Optional parameters are listed in parentheses
##
######################################################################

######################################################################
##        Native site authentication 

## Get an access token from native credentials
## POST params: user, pass 
- url: /login.*
  script: src.py.moracct.app

## Read native credentials and redirect back
## POST params: emailin, passin (,returnto, command, view, prof/pen/revid)
- url: /redirlogin.*
  script: src.py.moracct.app

## Create a new native account
## POST params: user, pass, email
- url: /newacct.*
  script: src.py.moracct.app

## Email forgotten native account credentials
## POST params: email
- url: /mailcred.*
  script: src.py.moracct.app

## Change native account password
## POST params: password, authparams
- url: /updacc.*
  script: src.py.moracct.app

## Get login account details
## GET params: authparams
- url: /getacct.*
  script: src.py.moracct.app

## Send account activation code
## POST params: authparams
- url: /sendcode.*
  script: src.py.moracct.app

## Activate or deactivate the account
## GET params: key, code, command, authparams
- url: /activate.*
  script: src.py.moracct.app

## Get build version string
## GET params: none
- url: /buildverstr.*
  script: src.py.moracct.app


######################################################################
##        Pen Names

## Fetch pen names for current authentication
## GET params: authparams
- url: /mypens.*
  script: src.py.pen.app

## Create new pen name for current authentication
## POST params: pen, authparams
- url: /newpen.*
  script: src.py.pen.app

## Update a pen name if authorized
## POST params: pen, authparams
- url: /updpen.*
  script: src.py.pen.app

## Upload a profile pic
## POST params: picfilein, _id, authparams
##   _id: The PenName instance id
- url: /profpicupload.*
  script: src.py.pen.app

## Retrieve a profile pic
## GET params: profileid
- url: /profpic.*
  script: src.py.pen.app

## Toggle remembering a review
## GET params: revid, penid, authparams
- url: /togremember.*
  script: src.py.pen.app

## Return pen names containing the qstr text.
## GET params: qstr, cursor, authparams
- url: /srchpens.*
  script: src.py.pen.app

## Return the pen name for the given id.
## GET params: penid
- url: /penbyid.*
  script: src.py.pen.app

## Return non-protected account information for the given pen
## GET params: penid, authparams
- url: /acctinfo
  script: src.py.pen.app

## Init an account email address for the given pen
## POST params: penid, email, authparams
- url: /penmail.*
  script: src.py.pen.app

## Note the given pen name was accessed
## POST params: penid, authparams
- url: /penacc.*
  script: src.py.pen.app


######################################################################
##        Reviews

## Initialize review reference fields
## GET params: none
- url: /revdatainit
  script: src.py.rev.app


## Verify existing database review instances, fixing as needed
## GET params: none
- url: /revcheckall
  script: src.py.rev.app


## Return the review feed for the given type
## GET params: revtype, authparams, penid
- url: /revfeed
  script: src.py.rev.app


## Toggle the helpful mark on the specified review from the specified pen
## GET params: revid, penid, authparams
- url: /toghelpful.*
  script: src.py.rev.app


## Create a new review for authorized pen name
## POST params: rev, authparams (, mode)
##   mode=batch leaves a processing note to avoid flooding the activity feed
- url: /newrev.*
  script: src.py.rev.app


## Update review for authorized pen name
## POST params: rev, authparams
##   _id of rev required
- url: /updrev.*
  script: src.py.rev.app


## Delete review for authorized pen name
## POST params: rev, authparams
- url: /delrev.*
  script: src.py.rev.app
  

## Upload a review pic
## POST params: picfilein, _id, authparams
##   _id: The Review instance id
- url: /revpicupload.*
  script: src.py.rev.app

## Retrieve a review pic
## GET params: revid
- url: /revpic.*
  script: src.py.rev.app


## Return reviews for a given pen within the given date range
## GET params: penid, mindate, maxdate, qstr, authparams (,revtype)
- url: /srchrevs.*
  script: src.py.rev.app


## Return the review for the given id.
## GET params: revid
- url: /revbyid.*
  script: src.py.rev.app


## Return the review looking up by revtype and cankey
## GET params: penid, revtype, cankey, authparams
- url: /revbykey
  script: src.py.rev.app


## Return pre-reviews for the given pen
## GET params: penid, authparams
- url: /fetchprerevs.*
  script: src.py.rev.app


######################################################################
##        Groups

## Create a new group or update a group description
## POST params: penid, group, authparams
- url: /grpdesc.*
  script: src.py.group.app

## Return the group for the given id
## GET params: groupid
- url: /grpbyid.*
  script: src.py.group.app

## Upload a group pic
## POST params: picfilein, _id, authparams
##   _id: Group instance id
- url: /grppicupload.*
  script: src.py.group.app

## Retrieve a group pic
## GET params: groupid
- url: /grppic.*
  script: src.py.group.app

## Post a review to a group
## POST params: penid, revid, groupid, authparams
- url: /grprev.*
  script: src.py.group.app

## Remove a posted review from a group
## POST params: penid, revid, groupid, reason, authparams
- url: /grpremrev.*
  script: src.py.group.app

## Apply for next level group membership
## POST params: penid, groupid, authparams
- url: /grpmemapply.*
  script: src.py.group.app

## Withdraw application for next level group membership
## POST params: penid, groupid, authparams
- url: /grpmemwithdraw.*
  script: src.py.group.app

## Reject application for next level group membership
## POST params: penid, groupid, seekerid, authparams
- url: /grpmemrej.*
  script: src.py.group.app

## Acknowledge rejection of group membership application
## POST params: penid, groupid, authparams
- url: /grprejok.*
  script: src.py.group.app

## Accept group membership application
## POST params: penid, groupid, seekerid, authparams
- url: /grpmemyes.*
  script: src.py.group.app

## Remove group membership
## POST params: penid, groupid, removeid, authparams
- url: /grpmemremove.*
  script: src.py.group.app

## Fetch groups by name
## GET params: groupname
- url: /grpbyname.*
  script: src.py.group.app

## Fetch general group statistics
## GET params: none
- url: /grpstats.*
  script: src.py.group.app

## Return groups whose name contains the qstr text
## GET params: qstr, cursor, authparams
- url: /srchgroups.*
  script: src.py.group.app


######################################################################
##        Connection Services

## Return a signed OAuth request given the specified parameters
## POST params: name, posturl, headparams, contentparams
- url: /oa1call.*
  script: src.py.consvc.app

## Return the specified JSON endpoint call results
## GET params: geturl
- url: /jsonget.*
  script: src.py.consvc.app

## Undecorated return endpoint for Twitter to callback
## GET params: oauth token info
- url: /twtok
  script: src.py.consvc.app

## Fetch an access token for GitHub
## GET params: code, state
- url: /githubtok.*
  script: src.py.consvc.app

## GitHub authentication callback endpoint
## GET params: code, state
- url: /githubcb.*
  script: src.py.consvc.app

## Fetch info from Amazon
## GET params: asin, authparams
- url: /amazoninfo.*
  script: src.py.consvc.app

## Fetch search results from Amazon
## GET params: revtype, title, authparams
- url: /amazonsearch.*
  script: src.py.consvc.app

## Fetch the contents of the given URL
## GET params: url, authparams
- url: /urlcontents.*
  script: src.py.consvc.app

## Fetch the given image url and return it.
## GET params: url, authparams
- url: /imagerelay.*
  script: src.py.consvc.app


######################################################################
# Test endpoints, static displays, data summaries and other urls not
# really considered part of the API
#
- url: /penwalk
  script: src.py.pen.app
- url: /testpens
  script: src.py.pen.app
- url: /testrevs
  script: src.py.rev.app
- url: /blogs/.*
  script: src.py.blogview.app
- url: /emblog/.*
  script: src.py.blogview.app
- url: /groups/.*
  script: src.py.groupview.app
- url: /emgroup/.*
  script: src.py.groupview.app
- url: /statrev/\d+
  script: src.py.statrev.app
- url: /stats.*
  script: src.py.statweek.app
- url: /rssact.*
  script: src.py.rssact.app
- url: /rsspen.*
  script: src.py.rssact.app
- url: /rssgrp.*
  script: src.py.rssact.app
- url: /mailsum.*
  script: src.py.mailsum.app
- url: /emuser.*
  script: src.py.mailsum.app
- url: /activity.*
  script: src.py.mailsum.app
- url: /bytheway.*
  script: src.py.mailsum.app
- url: /bytheimg.*
  script: src.py.mailsum.app
- url: /botids.*
  script: src.py.mailsum.app
- url: /fixrefkeys.*
  script: src.py.mailsum.app
- url: /_ah/bounce
  script: src.py.mailsum.app
  login: admin
# Trap anything ending with a slash and send it to index.html since there
# is no default processing to figure that out otherwise.
- url: (.*)/
  static_files: docroot/index.html
  upload: docroot
# Catchall is to look in docroot.
- url: /
  static_dir: docroot
